require("resty.core")

local block = ""

-- skip favicon
if ngx.var.uri == "/favicon.ico" then return ngx.location.capture(ngx.var.uri) end
ngx.log(ngx.INFO, block, "################################################################################")

-- import requirements
local cjson = require("cjson")
local https = require("ssl.https")
local url = require("socket.url")
local ltn12 = require("ltn12")
local aes = require("resty.aes")

-- TODO: make this an oauth lib
local oauth = {
    app_id = "@APP_ID@",
    app_secret = "@APP_SECRET@",
    orgs_whitelist = {["@ORG@"]=true},
    aes_secret = "@AES_SECRET@",

    scope = "repo,user,user:email,read:org",
    authorize_base_url = "https://github.com/login/oauth/authorize",
    access_token_url = "https://github.com/login/oauth/access_token",
    user_orgs_url = "https://api.github.com/user/orgs",
}

local crypter = aes:new(oauth.aes_secret, nil, aes.cipher(128, "ofb"))

oauth.authorize_url = oauth.authorize_base_url.."?client_id="..oauth.app_id.."&scope="..oauth.scope

function oauth.request(url_string, method)
    local result_table = {}

    local url_table = {
      url = url.build(url.parse(url_string, {port = 443})),
      method = method,
      sink = ltn12.sink.table(result_table),
      headers = {
        ["accept"] = "application/json"
      }
    }

    local body, code, headers, status_line = https.request(url_table)

    local json_body = ""
    for i, value in ipairs(result_table) do json_body = json_body .. value end

    ngx.log(ngx.INFO, block, "body::", json_body)

    return {body=cjson.decode(json_body), status=code, headers=headers}
end

function oauth.get(url_string)
    return oauth.request(url_string, "GET")
end

function oauth.get_access_token(code)

    local params = {
        access_token_url=oauth.access_token_url,
        client_id=oauth.app_id,
        client_secret=oauth.app_secret,
        code=code,
        redirect_uri=oauth.redirect_uri,
    }

    local url_string = oauth.access_token_url.."?"..ngx.encode_args(params)

    return oauth.get(url_string)
end


function oauth.verify_user(access_token)
    local params = {access_token=access_token}
    local url_string = oauth.user_orgs_url.."?"..ngx.encode_args(params)
    local response = oauth.get(url_string)
    local body = response.body

    if body.error then
        return {status=401, message=body.error}
    end

    for i, org in ipairs(body) do
        ngx.log(ngx.INFO, block, "testing", org.login)

        if oauth.orgs_whitelist[org.login] then
            ngx.log(ngx.INFO, block, org.login, " is in orgs_whitelist")
            return {status=200, body={access_token=access_token, org=org, access_level=9001}}
        end
    end

    return {status=403, message='not authorized for any orgs'}
end

--- end oauth lib


local args = ngx.req.get_uri_args()
local cookie_jar = {}


function string.starts(String, Start)
	return string.sub(String, 1, string.len(Start)) == Start
end

local function set_cookies(cookie_jar)
  local vals={}
  for k,v in pairs(cookie_jar) do table.insert(vals,v) end
  ngx.header["Set-Cookie"] = vals
end

local function del_cookie(c, cookie_jar)
  cookie_jar[c] = c.."=deleted; path=/; Expires=Thu, 01-Jan-1970 00:00:01 GMT"
  set_cookies(cookie_jar)
end

local function set_cookie(c, v, cookie_jar, age)
  age = age or 3000
  cookie_jar[c] = c.."="..v.."; path=/;Max-Age="..age
  set_cookies(cookie_jar)
end


local function unauthorized(status, message, token, return_json)
	-- Expire their stored token
	del_cookie('NGAccessToken', cookie_jar)
	del_cookie('NGAuthorized', cookie_jar)
	set_cookies(cookie_jar)

	ngx.log(ngx.ERR, "Unauthorized access: ", token)
	ngx.status = ngx.HTTP_UNAUTHORIZED
	if return_json then
		ngx.header.content_type = "application/json"
		ngx.say('{"status": '..status..', "message": '..msg..'}')
	else
		ngx.header.content_type = "text/html"
		ngx.say('<html><body><h1>', message, '</h1></body></html>')
	end
end

-- extract previous token from cookie if it is there
if access_token then
	access_token = ngx.decode_base64(access_token)
	if access_token then
		access_token = crypter:decrypt(access_token)
		if access_token == "" then access_token = nil end
	end
end
if authorized then
	authorized = ngx.decode_base64(authorized)
	if authorized then
		authorized = crypter:decrypt(authorized)
		if authorized ~= access_token.."true" then authorized = nil end
	end
end

if access_token then set_cookie('NGAccessToken', ngx.encode_base64(crypter:encrypt(access_token)), cookie_jar) end
if authorized then set_cookie('NGAuthorized', ngx.encode_base64(crypter:encrypt(access_token.."true")), cookie_jar) end

-- We have nothing, do it all
if not access_token then
    block = "[A]"
    ngx.log(ngx.INFO, block, 'authorized=', authorized)
    ngx.log(ngx.INFO, block, 'access_token=', access_token)

    -- first lets check for a code where we retrieve
    -- credentials from the api
    if not access_token or args.code then
        if args.code then
            response = oauth.get_access_token(args.code)

            -- kill all invalid responses immediately
            if response.status ~= 200 or response.body.error then
                ngx.status = response.status
                ngx.header.content_type = "application/json"
                response.body.auth_wall = "something went wrong with the OAuth process"
                ngx.say(cjson.encode(response.body))
                ngx.exit(ngx.HTTP_OK)
            end

            -- decode the token
            access_token = response.body.access_token
        end

        -- both the cookie and proxy_pass token retrieval failed
        if not access_token then
            local redirect_uri = ngx.var.cookie_NGRedirectURI or ngx.var.uri
            local redirect_args = ngx.var.cookie_NGRedirectArgs or ngx.var.args
            if string.starts(redirect_uri, "/_callback") then
                redirect_uri = "/"
                redirect_args = nil
            end
            ngx.log(ngx.INFO, block, 'no access_token')

            if redirect_uri then set_cookie('NGRedirectURI', redirect_uri, cookie_jar, 120) end
            if redirect_args then set_cookie('NGRedirectArgs', redirect_args, cookie_jar, 120) end

            -- Redirect to the /oauth endpoint, request access to ALL scopes
            set_cookies(cookie_jar)
            return ngx.redirect(oauth.authorize_url)
        end
    end
end


-- Not authorized with current access_token
if authorized ~= access_token.."true" then
    block = "[B]"
    ngx.log(ngx.INFO, block, 'authorized=', authorized)
    ngx.log(ngx.INFO, block, 'access_token=', access_token)
    -- ensure we have a user with the proper access app-level
    local verify_user_response = oauth.verify_user(access_token)
    if verify_user_response.status ~= 200 then
        -- delete their bad token
        del_cookie('NGAccessToken', cookie_jar)
        del_cookie('NGAuthorized', cookie_jar)
        set_cookies(cookie_jar)

        -- 403 means that user not in required group. Display text message about why he have no permission to view this page
        if verify_user_response.status == 403 then
            unauthorized(verify_user_response.status, verify_user_response.message, access_token, true)
            return ngx.exit(ngx.HTTP_OK)
        end

        -- Disallow access
        ngx.status = verify_user_response.status
        ngx.say('{"status": 503, "message": "Error accessing oauth.api for credentials"}')

        return ngx.exit(ngx.HTTP_OK)
    end

    -- Ensure we have the minimum for access_level to this resource
    if verify_user_response.body.access_level < 255 then
        unauthorized(403, '"USER_ID '..access_token..' has no access to this resource"', access_token, true)

        return ngx.exit(ngx.HTTP_OK)
    end

    -- Store the access_token within a cookie
    set_cookie('NGAccessToken', ngx.encode_base64(crypter:encrypt(access_token)), cookie_jar)
    set_cookie('NGAuthorized', ngx.encode_base64(crypter:encrypt(access_token.."true")), cookie_jar)
end

-- should be authorized by now

-- Support redirection back to your request if necessary
local redirect_uri = ngx.var.cookie_NGRedirectUri
local redirect_args = ngx.var.cookie_NGRedirectArgs

if redirect_args then
    if redirect_args then
        redirect_uri = redirect_uri.."?"..redirect_args
    end
    ngx.log(ngx.INFO, block, "Redirecting to ", redirect_uri)
    del_cookie('NGRedirectURI', cookie_jar)
    del_cookie('NGRedirectArgs', cookie_jar)
    set_cookies(cookie_jar)
    return ngx.redirect(redirect_uri)
end
ngx.log(ngx.INFO, block, "--------------------------------------------------------------------------------")
